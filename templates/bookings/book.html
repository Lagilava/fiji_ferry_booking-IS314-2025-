{% extends 'base.html' %}
{% load static %}

{% block title %}Book Your Ferry - Fiji Ferry Booking{% endblock %}

{% block content %}
<main class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold text-center text-var-primary mb-8 font-playfair">Book Your Ferry</h1>
    <div class="progress-bar bg-gray-200 rounded-full h-2 mb-8">
        <div class="progress-bar-fill bg-var-step-1-accent rounded-full h-full transition-all duration-300"></div>
    </div>
    <div class="steps flex justify-between mb-8">
        <div class="step flex-1 text-center font-poppins" data-step="1">
            <span class="step-number block w-8 h-8 mx-auto rounded-full bg-var-step-1-accent text-white flex items-center justify-center">1</span>
            <span class="step-label block text-sm text-var-text-color">Select Schedule</span>
        </div>
        <div class="step flex-1 text-center font-poppins" data-step="2">
            <span class="step-number block w-8 h-8 mx-auto rounded-full bg-gray-300 text-gray-600 flex items-center justify-center">2</span>
            <span class="step-label block text-sm text-var-text-color">Passenger Details</span>
        </div>
        <div class="step flex-1 text-center font-poppins" data-step="3">
            <span class="step-number block w-8 h-8 mx-auto rounded-full bg-gray-300 text-gray-600 flex items-center justify-center">3</span>
            <span class="step-label block text-sm text-var-text-color">Additional Services</span>
        </div>
        <div class="step flex-1 text-center font-poppins" data-step="4">
            <span class="step-number block w-8 h-8 mx-auto rounded-full bg-gray-300 text-gray-600 flex items-center justify-center">4</span>
            <span class="step-label block text-sm text-var-text-color">Summary</span>
        </div>
    </div>

    <div class="booking-form-container bg-var-card-bg rounded-lg shadow-lg p-6 max-w-2xl mx-auto" data-aos="fade-up">
        <form id="booking-form" action="{% url 'bookings:book_ticket' %}" method="post" enctype="multipart/form-data" aria-label="Ferry booking form">
            {% csrf_token %}
            <input type="hidden" name="step" value="{{ form_data.step|default:1 }}">

            <!-- Step 1: Select Schedule -->
            <div class="form-step step-1 active" data-step="1">
                <div class="step-description bg-var-step-1-bg p-4 rounded-lg mb-4 text-var-text-color font-poppins">
                    <p class="text-sm">Choose your ferry schedule. All fields are required.</p>
                </div>
                <div class="form-group">
                    <label for="schedule_id" class="block text-sm font-semibold text-var-text-color font-poppins">Select Schedule</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-var-text-color" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <select id="schedule_id" name="schedule_id" required class="w-full pl-10 p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-1-accent">
                            <option value="">Select a schedule</option>
                            {% for schedule in schedules %}
                                <option value="{{ schedule.id }}" {% if form_data.schedule_id == schedule.id %}selected{% endif %}>
                                    {{ schedule.route.departure_port.name }} to {{ schedule.route.destination_port.name }} - {{ schedule.departure_time|date:"D, M d, H:i" }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% if not user.is_authenticated %}
                <div class="form-group mt-4">
                    <label for="guest_email" class="block text-sm font-semibold text-var-text-color font-poppins">Guest Email</label>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-var-text-color" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <input type="email" id="guest_email" name="guest_email" value="{{ form_data.guest_email|default:"" }}" required class="w-full pl-10 p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-1-accent" aria-required="true" placeholder="Enter your email">
                    </div>
                </div>
                {% endif %}
                <div class="form-actions mt-6 flex justify-end">
                    <button type="button" class="next-step cta-button bg-var-step-1-accent text-white py-2 px-4 rounded hover:bg-var-step-1-accent-hover focus:outline-none focus:ring-2 focus:ring-var-step-1-accent flex items-center" data-next="2">
                        <span class="spinner hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                        Next
                    </button>
                </div>
            </div>

            <!-- Step 2: Passenger Details -->
            <div class="form-step step-2" data-step="2" style="display: none;">
                <div class="step-description bg-var-step-2-bg p-4 rounded-lg mb-4 text-var-text-color font-poppins">
                    <p class="text-sm">Enter details for each passenger. Fields marked with <span class="italic">* are required</span>.</p>
                </div>
                <div class="form-group">
                    <label for="adults" class="block text-sm font-semibold text-var-text-color font-poppins">Adults (18+)</label>
                    <input type="number" id="adults" name="adults" min="0" value="{{ form_data.adults|default:0 }}" required class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-2-accent" aria-required="true">
                </div>
                <div class="form-group mt-4">
                    <label for="youths" class="block text-sm font-semibold text-var-text-color font-poppins">Youths (13-17)</label>
                    <input type="number" id="youths" name="youths" min="0" value="{{ form_data.youths|default:0 }}" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-2-accent">
                </div>
                <div class="form-group mt-4">
                    <label for="children" class="block text-sm font-semibold text-var-text-color font-poppins">Children (2-12)</label>
                    <input type="number" id="children" name="children" min="0" value="{{ form_data.children|default:0 }}" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-2-accent">
                </div>
                <div class="form-group mt-4">
                    <label for="infants" class="block text-sm font-semibold text-var-text-color font-poppins">Infants (0-2)</label>
                    <input type="number" id="infants" name="infants" min="0" value="{{ form_data.infants|default:0 }}" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-2-accent">
                </div>
                <div id="passenger-details" class="space-y-4">
                    <div id="passenger-details-error" class="hidden text-sm text-var-alert-error-text font-poppins"></div>
                    <div id="adult-fields"></div>
                    <div id="youth-fields"></div>
                    <div id="child-fields"></div>
                    <div id="infant-fields"></div>
                    <div id="responsibility-declaration-fields" class="hidden">
                        <div class="form-group">
                            <label for="responsibility_declaration" class="block text-sm font-semibold text-var-text-color font-poppins">Responsibility Declaration</label>
                            <input type="file" id="responsibility_declaration" name="responsibility_declaration" accept=".pdf,.jpg,.jpeg,.png" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-2-accent">
                            <div class="file-preview hidden mt-2"></div>
                        </div>
                    </div>
                </div>
                <div class="form-actions mt-6 flex justify-between">
                    <button type="button" class="prev-step cta-button bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center" data-prev="1">Previous</button>
                    <button type="button" class="next-step cta-button bg-var-step-2-accent text-white py-2 px-4 rounded hover:bg-var-step-2-accent-hover focus:outline-none focus:ring-2 focus:ring-var-step-2-accent flex items-center" data-next="3">
                        <span class="spinner hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                        Next
                    </button>
                </div>
            </div>

            <!-- Step 3: Additional Services -->
            <div class="form-step step-3" data-step="3" style="display: none;">
                <div class="step-description bg-var-step-3-bg p-4 rounded-lg mb-4 text-var-text-color font-poppins">
                    <p class="text-sm">Add optional services like cargo or special requirements.</p>
                </div>
                <div class="form-group">
                    <label class="flex items-center">
                        <input type="checkbox" id="add_cargo_checkbox" name="add_cargo" {% if form_data.add_cargo %}checked{% endif %} class="mr-2 h-5 w-5 text-var-step-3-accent focus:ring-var-step-3-accent border-var-border-color">
                        <span class="text-sm font-semibold text-var-text-color font-poppins">Add Cargo</span>
                    </label>
                </div>
                <div id="cargo-fields" class="hidden space-y-4 mt-4">
                    <div class="form-group">
                        <label for="cargo_type" class="block text-sm font-semibold text-var-text-color font-poppins">Cargo Type *</label>
                        <select id="cargo_type" name="cargo_type" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-3-accent" required>
                            <option value="" {% if not form_data.cargo_type %}selected{% endif %}>Select cargo type</option>
                            <option value="parcel" {% if form_data.cargo_type == "parcel" %}selected{% endif %}>Parcel</option>
                            <option value="pallet" {% if form_data.cargo_type == "pallet" %}selected{% endif %}>Pallet</option>
                            <option value="vehicle" {% if form_data.cargo_type == "vehicle" %}selected{% endif %}>Vehicle</option>
                            <option value="bulk" {% if form_data.cargo_type == "bulk" %}selected{% endif %}>Bulk</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weight_kg" class="block text-sm font-semibold text-var-text-color font-poppins">Weight (kg) *</label>
                        <input type="number" id="weight_kg" name="weight_kg" min="0" step="0.1" value="{{ form_data.weight_kg|default:"" }}" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-3-accent" placeholder="Enter weight in kg" required>
                    </div>
                    <div class="form-group">
                        <label for="dimensions_cm" class="block text-sm font-semibold text-var-text-color font-poppins">Dimensions (cm)</label>
                        <input type="text" id="dimensions_cm" name="dimensions_cm" value="{{ form_data.dimensions_cm|default:"" }}" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-3-accent" placeholder="e.g., 50x30x20">
                    </div>
                </div>
                <div class="form-group mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_unaccompanied_minor" name="is_unaccompanied_minor" {% if form_data.is_unaccompanied_minor %}checked{% endif %} class="mr-2 h-5 w-5 text-var-step-3-accent focus:ring-var-step-3-accent border-var-border-color">
                        <span class="text-sm font-semibold text-var-text-color font-poppins">Unaccompanied Minor</span>
                    </label>
                </div>
                <div id="unaccompanied-minor-fields" class="hidden space-y-4 mt-4">
                    <div class="form-group">
                        <label for="guardian_contact" class="block text-sm font-semibold text-var-text-color font-poppins">Guardian Contact *</label>
                        <input type="text" id="guardian_contact" name="guardian_contact" value="{{ form_data.guardian_contact|default:"" }}" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-3-accent" placeholder="Enter guardian's contact details" required>
                    </div>
                    <div class="form-group">
                        <label for="consent_form" class="block text-sm font-semibold text-var-text-color font-poppins">Consent Form *</label>
                        <input type="file" id="consent_form" name="consent_form" accept=".pdf,.jpg,.jpeg,.png" class="w-full p-2 border rounded bg-var-input-bg text-var-text-color focus:outline-none focus:ring-2 focus:ring-var-step-3-accent" required>
                        <div class="file-preview hidden mt-2"></div>
                    </div>
                </div>
                <div class="form-group mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_group_booking" name="is_group_booking" {% if form_data.is_group_booking %}checked{% endif %} class="mr-2 h-5 w-5 text-var-step-3-accent focus:ring-var-step-3-accent border-var-border-color">
                        <span class="text-sm font-semibold text-var-text-color font-poppins">Group Booking</span>
                    </label>
                </div>
                <div class="form-group mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="is_emergency" name="is_emergency" {% if form_data.is_emergency %}checked{% endif %} class="mr-2 h-5 w-5 text-var-step-3-accent focus:ring-var-step-3-accent border-var-border-color">
                        <span class="text-sm font-semibold text-var-text-color font-poppins">Emergency Travel (FJD 50.00 surcharge)</span>
                    </label>
                </div>
                <div class="form-actions mt-6 flex justify-between">
                    <button type="button" class="prev-step cta-button bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center" data-prev="2">Previous</button>
                    <button type="button" class="next-step cta-button bg-var-step-3-accent text-white py-2 px-4 rounded hover:bg-var-step-3-accent-hover focus:outline-none focus:ring-2 focus:ring-var-step-3-accent flex items-center" data-next="4">
                        <span class="spinner hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                        Next
                    </button>
                </div>
            </div>

            <!-- Step 4: Summary -->
            <div class="form-step step-4" data-step="4" style="display: none;">
                <div class="step-description bg-var-step-4-bg p-4 rounded-lg mb-4 text-var-text-color font-poppins">
                    <p class="text-sm">Review your booking details and proceed to payment.</p>
                </div>
                <div class="summary bg-var-step-4-bg p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-var-primary font-poppins">Booking Summary</h3>
                    <p class="text-sm text-var-text-color font-poppins"><strong>Schedule:</strong> <span id="summary-schedule">Not selected</span></p>
                    <p class="text-sm text-var-text-color font-poppins"><strong>Passengers:</strong> <span id="summary-passengers">0 Adults, 0 Youths, 0 Children, 0 Infants</span></p>
                    <p class="text-sm text-var-text-color font-poppins"><strong>Passenger Breakdown:</strong> <span id="summary-passenger-breakdown"></span></p>
                    <p class="text-sm text-var-text-color font-poppins"><strong>Cargo:</strong> <span id="summary-cargo">None</span></p>
                    <p class="text-sm text-var-text-color font-poppins"><strong>Extras:</strong> <span id="summary-extras">None</span></p>
                    <p class="text-lg font-bold text-var-primary font-poppins mt-4"><strong>Total Cost:</strong> FJD <span id="summary-cost">0.00</span></p>
                </div>
                <div class="form-group mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="privacy-consent" name="privacy_consent"
                               {% if form_data.privacy_consent %}checked{% endif %}
                               required class="mr-2 h-5 w-5 text-var-step-4-accent focus:ring-var-step-4-accent border-var-border-color">
                        <span class="text-sm font-semibold text-var-text-color font-poppins">
                            I agree to the
                            <a href="{% url 'privacy_policy' %}" target="_blank" class="underline text-var-step-4-accent hover:text-var-step-4-accent-hover">
                                Privacy Policy
                            </a>
                            and Terms of Service
                        </span>
                    </label>
                </div>
                <div class="form-actions mt-6 flex justify-between">
                    <button type="button" class="prev-step cta-button bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 flex items-center" data-prev="3">Previous</button>
                    <button type="button" id="proceed-to-payment" class="cta-button bg-var-step-4-accent text-white py-2 px-4 rounded hover:bg-var-step-4-accent-hover focus:outline-none focus:ring-2 focus:ring-var-step-4-accent flex items-center">
                        <span class="spinner hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>
                        Proceed to Payment
                    </button>
                </div>
            </div>
        </form>
    </div>
</main>
{% endblock %}

{% block extra_css %}
<style>
:root {
    --bg-color: #F5F6F5;
    --bg-secondary: #FFFFFF;
    --card-bg: #FFFFFF;
    --input-bg: #E8ECEF;
    --text-color: #263238;
    --primary: #1E88E5;
    --button-bg: #1E88E5;
    --button-hover: #1565C0;
    --highlight-bg: #FF6F61;
    --highlight-hover: #E55A4F;
    --border-color: #D1D5DB;
    --alert-error-text: #DC2626;
    --step-1-bg: #E3F2FD;
    --step-1-accent: #1E88E5;
    --step-1-accent-hover: #1565C0;
    --step-2-bg: #E8F5E9;
    --step-2-accent: #2E7D32;
    --step-2-accent-hover: #1B5E20;
    --step-3-bg: #E0F2F1;
    --step-3-accent: #00897B;
    --step-3-accent-hover: #00695C;
    --step-4-bg: #FFF3E0;
    --step-4-accent: #EF6C00;
    --step-4-accent-hover: #D45D00;
}

.dark {
    --bg-color: #1A2526;
    --bg-secondary: #12191A;
    --card-bg: #263238;
    --input-bg: #37474F;
    --text-color: #CFD8DC;
    --primary: #42A5F5;
    --button-bg: #0D47A1;
    --button-hover: #1565C0;
    --highlight-bg: #26A69A;
    --highlight-hover: #00897B;
    --border-color: #4B5E6A;
    --alert-error-text: #F87171;
    --step-1-bg: #1E3A5F;
    --step-1-accent: #42A5F5;
    --step-1-accent-hover: #1976D2;
    --step-2-bg: #1A3D2E;
    --step-2-accent: #81C784;
    --step-2-accent-hover: #4CAF50;
    --step-3-bg: #1A3D3B;
    --step-3-accent: #26A69A;
    --step-3-accent-hover: #00897B;
    --step-4-bg: #3D2F1A;
    --step-4-accent: #FFCA28;
    --step-4-accent-hover: #FFB300;
}

body { font-family: 'Poppins', sans-serif; }

.container {
    max-width: 1280px;
    margin: 60px auto;
    padding: 0 20px;
}

.progress-bar {
    background: var(--input-bg);
}

.progress-bar-fill {
    background: var(--step-1-accent);
    transition: width 0.3s ease, background 0.3s ease;
}

.step[data-step="1"].active .step-number { background: var(--step-1-accent); }
.step[data-step="2"].active .step-number { background: var(--step-2-accent); }
.step[data-step="3"].active .step-number { background: var(--step-3-accent); }
.step[data-step="4"].active .step-number { background: var(--step-4-accent); }
.step.completed .step-number { background: var(--primary); }

.step-description {
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.passenger-fieldset {
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.passenger-fieldset-header {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    cursor: pointer;
}

.passenger-fieldset-header h4 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.1rem;
    color: var(--text-color);
}

.toggle-icon {
    font-size: 1.2rem;
    color: var(--text-color);
}

.passenger-fieldset-content {
    display: none;
    padding-top: 1rem;
}

.passenger-fieldset-content.open {
    display: block;
}

.file-preview img {
    max-width: 100%;
    max-height: 100px;
    object-fit: contain;
    border-radius: 0.25rem;
}

.file-preview .pdf-icon {
    background: var(--input-bg);
    color: var(--text-color);
    padding: 0.5rem;
    border-radius: 0.25rem;
    display: inline-block;
}

.error-message {
    color: var(--alert-error-text);
}

.alert.error {
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid var(--alert-error-text);
}

.dark .alert.error {
    background: rgba(248, 113, 113, 0.1);
}

.tooltip-text {
    width: 200px;
    top: 100%;
    left: 0;
    transform: translateY(8px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.form-step:not(.active) { display: none !important; }
.form-step.active { display: block; }
.form-step[data-step="1"].active .progress-bar-fill { background: var(--step-1-accent); }
.form-step[data-step="2"].active .progress-bar-fill { background: var(--step-2-accent); }
.form-step[data-step="3"].active .progress-bar-fill { background: var(--step-3-accent); }
.form-step[data-step="4"].active .progress-bar-fill { background: var(--step-4-accent); }

@media (max-width: 768px) {
    .container { max-width: 90%; }
    .steps { flex-direction: column; gap: 1rem; }
    .step { flex: none; }
    .booking-form-container { padding: 1rem; }
}

.flatpickr-calendar { background: var(--input-bg); color: var(--text-color); }
.flatpickr-day.selected { background: var(--button-bg); border-color: var(--button-bg); }
.dark .flatpickr-calendar { background: var(--input-bg); color: var(--text-color); }
.dark .flatpickr-day.selected { background: var(--button-bg); border-color: var(--button-bg); }
</style>
{% endblock %}

{% block extra_js %}
<script>
    window.isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
</script>
<script>
    window.urls = {
        getPricing: "{% url 'bookings:get-pricing' %}",
        validateStep: "{% url 'bookings:validate_step' %}",
        validateFile: "{% url 'bookings:validate_file' %}",
        createCheckoutSession: "{% url 'bookings:create_checkout_session' %}"
    };
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">
<script src="https://js.stripe.com/v3/"></script>
<script>
    (function () {
        window.stripe = Stripe('{{ stripe_publishable_key }}');
    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js" defer></script>
<script>
    window.APP_CONFIG = {
        baseUrl: '{% url "bookings:validate_file" %}'.replace(/\/validate_file\/$/, ''),
        stripePublicKey: '{{ stripe_publishable_key }}'
    };
</script>
<script src="{% static 'js/book.js' %}?v=10" defer></script>
{% endblock %}