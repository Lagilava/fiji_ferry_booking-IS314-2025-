{% extends 'base.html' %}
{% load static %}
{% load bookings_tags %}

{% block title %}Book Your Ferry - Fiji Ferry Booking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />
<link rel="stylesheet" href="{% static 'css/booking.css' %}" />
<style>
    .form-step { display: none; }
    .form-step.active { display: block; }
</style>
{% endblock %}

{% block content %}
<a href="#main-content" class="sr-only focus:not-sr-only fixed top-4 left-4 z-50 bg-primary text-white px-4 py-2 rounded focus:outline-none">
    Skip to main content
</a>

<main id="main-content" class="container mx-auto px-4 py-8 md:py-12 max-w-7xl">
    <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 md:mb-8">Book Your Ferry</h1>

    <!-- Progress Bar -->
    <div class="progress-bar mb-8" role="progressbar" aria-valuemin="0" aria-valuemax="4" aria-valuenow="{{ form_data.step|default:1 }}">
        <div class="progress-bar-fill" id="progress-bar-fill" aria-hidden="true"></div>
    </div>

    <!-- Step Navigation -->
    <nav aria-label="Booking progress" class="steps mb-8">
        <ol class="flex justify-between">
            <li class="step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">Schedule</span>
            </li>
            <li class="step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">Passengers</span>
            </li>
            <li class="step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-label">Add-Ons</span>
            </li>
            <li class="step" data-step="4">
                <span class="step-number">4</span>
                <span class="step-label">Review</span>
            </li>
        </ol>
    </nav>

    <div class="booking-form-container">
        <form id="booking-form" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <input type="hidden" name="step" id="current-step" value="{{ form_data.step|default:1 }}">

            <!-- STEP 1: Schedule Selection -->
            <section class="form-step active" data-step="1">
                <div class="step-description">
                    <h2 class="sr-only">Step 1: Select Schedule</h2>
                    <p>Choose your ferry schedule. All fields are required.</p>
                </div>

                <div class="form-group mb-6">
                    <label for="schedule_id" class="block text-sm font-semibold mb-2">Ferry Schedule *</label>
                    <select id="schedule_id" name="schedule_id" required class="form-select w-full">
                        <option value="">Choose a schedule</option>
                        {% for schedule in schedules %}
                            <option value="{{ schedule.id }}"
                                    {% if form_data.schedule_id == schedule.id|stringformat:"s" %}selected{% endif %}>
                                {{ schedule.route.departure_port.name }} → {{ schedule.route.destination_port.name }}
                                - {{ schedule.departure_time|date:"M d, Y H:i" }} ({{ schedule.available_seats }} seats)
                            </option>
                        {% empty %}
                            <option disabled>No schedules available</option>
                        {% endfor %}
                    </select>
                    <p id="error-schedule_id" class="error-message text-red-500 text-sm mt-1" aria-live="polite"></p>
                </div>

                {% if not user.is_authenticated %}
                <div class="form-group mb-6">
                    <label for="guest_email" class="block text-sm font-semibold mb-2">Email Address *</label>
                    <input type="email" id="guest_email" name="guest_email"
                           value="{{ form_data.guest_email|default_if_none:'' }}"
                           required class="form-input w-full" placeholder="your.email@example.com">
                    <p id="error-guest_email" class="error-message text-red-500 text-sm mt-1" aria-live="polite"></p>
                </div>
                {% endif %}

                <div class="form-actions">
                    <button type="button" class="prev-step btn btn-secondary" data-prev="1" disabled>Previous</button>
                    <button type="button" class="next-step btn btn-primary" data-next="2">Next: Passengers</button>
                </div>
            </section>

            <!-- STEP 2: Passenger Details -->
            <section class="form-step" data-step="2">
                <div class="step-description">
                    <h2 class="sr-only">Step 2: Passenger Details</h2>
                    <p>Enter details for each passenger</p>
                </div>

                <!-- Passenger Counters -->
                <div class="passenger-counters grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="counter-group">
                        <label class="block text-sm font-medium mb-2">Adults (18+)</label>
                        <input type="number" id="adults" name="adults" min="1" max="20"
                               value="{{ form_data.adults|default:1 }}" required
                               class="w-full p-2 border rounded">
                        <p id="error-adults" class="error-message text-red-500 text-sm mt-1"></p>
                    </div>
                    <div class="counter-group">
                        <label class="block text-sm font-medium mb-2">Children (2-17)</label>
                        <input type="number" id="children" name="children" min="0" max="15"
                               value="{{ form_data.children|default:0 }}"
                               class="w-full p-2 border rounded">
                        <p id="error-children" class="error-message text-red-500 text-sm mt-1"></p>
                    </div>
                    <div class="counter-group">
                        <label class="block text-sm font-medium mb-2">Infants (0-2)</label>
                        <input type="number" id="infants" name="infants" min="0" max="5"
                               value="{{ form_data.infants|default:0 }}"
                               class="w-full p-2 border rounded">
                        <p id="error-infants" class="error-message text-red-500 text-sm mt-1"></p>
                    </div>
                </div>

                <!-- Passenger Field Containers -->
                <div id="adult-fields" class="space-y-4 mb-6"></div>
                <div id="child-fields" class="space-y-4 mb-6"></div>
                <div id="infant-fields" class="space-y-4 mb-6"></div>

                <!-- PASSENGER TEMPLATE -->
                <template id="passenger-field-template">
                    <div class="passenger-card p-4 border rounded-lg">
                        <button type="button" class="passenger-header flex justify-between w-full text-left mb-3" aria-expanded="true">
                            <span class="passenger-title font-medium">{type} Passenger #{index}</span>
                            <span class="toggle-icon">▼</span>
                        </button>
                        <div class="passenger-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="block text-sm font-medium mb-1">First Name *</label>
                                    <input type="text" name="{type}_first_name_{index}" required
                                           class="form-input w-full p-2 border rounded">
                                    <p class="error-message text-red-500 text-sm mt-1" id="error-{type}_first_name_{index}"></p>
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-medium mb-1">Last Name *</label>
                                    <input type="text" name="{type}_last_name_{index}" required
                                           class="form-input w-full p-2 border rounded">
                                    <p class="error-message text-red-500 text-sm mt-1" id="error-{type}_last_name_{index}"></p>
                                </div>
                            </div>

                            <!-- Age and Document (non-infants) -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4" data-for="non-infant">
                                <div class="form-group">
                                    <label class="block text-sm font-medium mb-1">Age *</label>
                                    <input type="number" name="{type}_age_{index}" min="2" max="120" required
                                           class="form-input w-full p-2 border rounded">
                                    <p class="error-message text-red-500 text-sm mt-1" id="error-{type}_age_{index}"></p>
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-medium mb-1">ID Document *</label>
                                    <input type="file" name="{type}_id_document_{index}" accept=".pdf,.jpg,.jpeg,.png" required
                                           class="form-input w-full p-2 border rounded">
                                    <div class="file-preview mt-2 p-2 bg-gray-50 rounded"></div>
                                    <p class="error-message text-red-500 text-sm mt-1" id="error-{type}_id_document_{index}"></p>
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-medium mb-1">Phone (Optional)</label>
                                    <input type="tel" name="{type}_phone_{index}"
                                           class="form-input w-full p-2 border rounded">
                                </div>
                            </div>

                            <!-- Infant DOB -->
                            <div class="form-group mt-4" data-for="infant">
                                <label class="block text-sm font-medium mb-1">Date of Birth *</label>
                                <input type="date" name="infant_dob_{index}" required
                                       class="form-input w-full p-2 border rounded">
                                <p class="error-message text-red-500 text-sm mt-1" id="error-infant_dob_{index}"></p>
                            </div>

                            <!-- Linked Adult -->
                            <div class="form-group mt-4" data-for="child-infant">
                                <label class="block text-sm font-medium mb-1">Accompanying Adult *</label>
                                <select name="{type}_linked_adult_{index}" required class="form-select w-full p-2 border rounded">
                                    <option value="">Select adult passenger</option>
                                </select>
                                <p class="error-message text-red-500 text-sm mt-1" id="error-{type}_linked_adult_{index}"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="form-actions">
                    <button type="button" class="prev-step btn btn-secondary" data-prev="1">Previous</button>
                    <button type="button" class="next-step btn btn-primary" data-next="3">Next: Add-Ons</button>
                </div>
            </section>

            <!-- STEP 3: Add-ons & Optional Services -->
            <section class="form-step" data-step="3">
                <div class="step-description">
                    <h2 class="sr-only">Step 3: Optional Services</h2>
                    <p>Add optional services to your booking</p>
                </div>

                <!-- Add-ons Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    {% for addon in add_ons %}
                    <div class="addon-card p-4 border rounded-lg hover:shadow-md">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold">{{ addon.label }}</h4>
                                <p class="text-sm text-gray-600">Per unit</p>
                            </div>
                            <span class="text-lg font-bold text-blue-600">FJD {{ addon.price }}</span>
                        </div>
                        <input type="number" name="{{ addon.id }}_quantity" min="0" max="{{ addon.max_quantity|default:10 }}"
                               value="{{ form_data|lookup:addon.id|default:0 }}"
                               class="w-full p-2 border rounded" placeholder="0">
                        <p id="error-{{ addon.id }}_quantity" class="error-message text-red-500 text-sm mt-1"></p>
                    </div>
                    {% empty %}
                    <p class="col-span-full text-center text-gray-500 py-8">No add-on services available</p>
                    {% endfor %}
                </div>

                <!-- Vehicle Section -->
                <fieldset class="vehicle-section mb-8 p-4 border rounded-lg">
                    <legend class="text-lg font-semibold mb-4">Vehicle Transport</legend>
                    <label class="flex items-center mb-4 cursor-pointer">
                        <input type="checkbox" id="add_vehicle" name="add_vehicle"
                               {% if form_data.add_vehicle == 'on' %}checked{% endif %}
                               class="mr-2">
                        <span>Add Vehicle to Booking</span>
                    </label>
                    <div id="vehicle-fields" class="{% if not form_data.add_vehicle %}hidden{% endif %} grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-sm font-medium mb-2">Vehicle Type *</label>
                            <select id="vehicle_type" name="vehicle_type" class="form-select w-full">
                                <option value="">Select type</option>
                                <option value="car" {% if form_data.vehicle_type == 'car' %}selected{% endif %}>Car/Sedan</option>
                                <option value="van" {% if form_data.vehicle_type == 'van' %}selected{% endif %}>Van/SUV</option>
                                <option value="truck" {% if form_data.vehicle_type == 'truck' %}selected{% endif %}>Truck</option>
                                <option value="motorcycle" {% if form_data.vehicle_type == 'motorcycle' %}selected{% endif %}>Motorcycle</option>
                            </select>
                            <p id="error-vehicle_type" class="error-message"></p>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium mb-2">Dimensions (LxWxH cm) *</label>
                            <input type="text" id="vehicle_dimensions" name="vehicle_dimensions"
                                   value="{{ form_data.vehicle_dimensions|default:'' }}"
                                   placeholder="480x180x150" class="form-input w-full">
                            <p id="error-vehicle_dimensions" class="error-message"></p>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium mb-2">License Plate</label>
                            <input type="text" id="vehicle_license_plate" name="vehicle_license_plate"
                                   value="{{ form_data.vehicle_license_plate|default:'' }}"
                                   class="form-input w-full">
                        </div>
                        <div class="form-group md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Registration Document</label>
                            <input type="file" id="vehicle_document" name="vehicle_document"
                                   accept=".pdf,.jpg,.jpeg,.png" class="form-input w-full">
                            <div class="file-preview mt-2" id="preview-vehicle_document"></div>
                        </div>
                    </div>
                </fieldset>

                <!-- Cargo Section -->
                <fieldset class="cargo-section p-4 border rounded-lg">
                    <legend class="text-lg font-semibold mb-4">Cargo Transport</legend>
                    <label class="flex items-center mb-4 cursor-pointer">
                        <input type="checkbox" id="add_cargo" name="add_cargo"
                               {% if form_data.add_cargo == 'on' %}checked{% endif %}
                               class="mr-2">
                        <span>Add Cargo to Booking</span>
                    </label>
                    <div id="cargo-fields" class="{% if not form_data.add_cargo %}hidden{% endif %} grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-sm font-medium mb-2">Cargo Type *</label>
                            <select id="cargo_type" name="cargo_type" class="form-select w-full">
                                <option value="">Select type</option>
                                <option value="luggage" {% if form_data.cargo_type == 'luggage' %}selected{% endif %}>Luggage</option>
                                <option value="equipment" {% if form_data.cargo_type == 'equipment' %}selected{% endif %}>Equipment</option>
                                <option value="freight" {% if form_data.cargo_type == 'freight' %}selected{% endif %}>Freight</option>
                            </select>
                            <p id="error-cargo_type" class="error-message"></p>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium mb-2">Weight (kg) *</label>
                            <input type="number" id="cargo_weight_kg" name="cargo_weight_kg"
                                   value="{{ form_data.cargo_weight_kg|default:'' }}" min="0.1" step="0.1"
                                   class="form-input w-full">
                            <p id="error-cargo_weight_kg" class="error-message"></p>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium mb-2">Dimensions (optional)</label>
                            <input type="text" id="cargo_dimensions_cm" name="cargo_dimensions_cm"
                                   value="{{ form_data.cargo_dimensions_cm|default:'' }}"
                                   placeholder="100x50x50" class="form-input w-full">
                        </div>
                        <div class="form-group md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Cargo Document</label>
                            <input type="file" id="cargo_document" name="cargo_document"
                                   accept=".pdf,.jpg,.jpeg,.png" class="form-input w-full">
                            <div class="file-preview mt-2" id="preview-cargo_document"></div>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="button" class="prev-step btn btn-secondary" data-prev="2">Previous</button>
                    <button type="button" class="next-step btn btn-primary" data-next="4">Review & Pay</button>
                </div>
            </section>

            <!-- STEP 4: Review & Payment -->
            <section class="form-step" data-step="4">
                <div class="step-description">
                    <h2 class="sr-only">Step 4: Review & Confirm</h2>
                    <p>Review your booking and proceed to payment</p>
                </div>

                <div id="booking-summary" class="mb-8">
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <div class="loading-spinner mx-auto mb-4 w-8 h-8 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
                        <p class="text-gray-600">Loading booking summary...</p>
                    </div>
                </div>

                <div class="form-group mb-6">
                    <label class="flex items-start">
                        <input type="checkbox" id="privacy_consent" name="privacy_consent" required
                               class="mr-3 mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500">
                        <span class="text-sm">
                            I agree to the
                            <a href="{% url 'privacy_policy' %}" target="_blank" class="text-blue-600 hover:underline">
                                Privacy Policy
                            </a>
                            and
                            <a href="{% url 'terms_of_service' %}" target="_blank" class="text-blue-600 hover:underline">
                                Terms of Service
                            </a> *
                        </span>
                    </label>
                    <p id="error-privacy_consent" class="error-message text-red-500 text-sm mt-2" aria-live="polite"></p>
                </div>

                <div class="form-actions">
                    <button type="button" class="prev-step btn btn-secondary" data-prev="3">Previous</button>
                    <button type="submit" id="submit-booking" class="btn btn-primary">
                        <span class="spinner hidden mr-2"></span>
                        Confirm & Pay Securely
                    </button>
                </div>
            </section>
        </form>
    </div>
</main>

    <!-- CRITICAL GLOBAL CONFIGURATION -->
    <script type="application/javascript">
    (function() {
        'use strict';

        try {
            // --- CSRF token ---
            const csrfToken = '{{ csrf_token }}';
            const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
            const formData = {{ form_data|default:"{}"|safe }};
            const bookingConfig = {
                stripeEnabled: {{ stripe_enabled|yesno:"true,false" }},  // Fixed boolean rendering
                validationEnabled: true,
                formExists: true,
                userAuthenticated: isAuthenticated,
            };

            // Define URLs with fallback
            window.urls = {
                getPricing: '{% url "bookings:api_pricing" %}'.trim() || '/bookings/api/pricing/',
                createCheckoutSession: '{% url "bookings:api_create_checkout_session" %}'.trim() || '/bookings/api/create_checkout_session/'
            };

            // Validate URLs
            if (!window.urls.createCheckoutSession || window.urls.createCheckoutSession === 'undefined') {
                window.urls.createCheckoutSession = '/bookings/api/create_checkout_session/';
            }
            if (!window.urls.getPricing || window.urls.getPricing === 'undefined') {
                window.urls.getPricing = '/bookings/api/pricing/';
            }

            window.bookingConfig = bookingConfig;
            window.bookingFormData = formData;
            window.csrfToken = csrfToken;

            console.log('✅ Global booking config loaded:', {
                urls: window.urls,
                config: bookingConfig
            });

        } catch (err) {
            console.error('❌ Global config setup failed:', err);
            // Fallback URLs
            window.urls = window.urls || {
                getPricing: '/bookings/api/pricing/',
                createCheckoutSession: '/bookings/api/create_checkout_session/'
            };
            console.log('🔧 Using fallback URLs:', window.urls);
        }
    })();
    </script>

{% endblock %}

{% block extra_js %}
<!-- 1. STRIPE FIRST (critical dependency) -->
<script src="https://js.stripe.com/v3/"></script>

<!-- 2. AOS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

<script>
window.isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
</script>


<!-- 3. VALIDATION UTILITIES -->
<script src="{% static 'js/validation.js' %}"></script>

<!-- 4. MAIN BOOKING LOGIC -->
<script src="{% static 'js/book.js' %}"></script>

<!-- 5. INITIALIZATION with robust error handling -->
<script>
(function() {
    'use strict';

    let initAttempts = 0;
    const maxAttempts = 30;

    function initializeBookingSystemSafe() {
        initAttempts++;

        const checks = {
            stripe: typeof Stripe !== 'undefined',
            bookingFn: typeof window.initializeBookingSystem === 'function',
            validation: !!window.validationUtils,
            config: !!window.bookingConfig && !!window.urls,
            formExists: !!document.getElementById('booking-form')
        };

        console.log(`Init attempt ${initAttempts}:`, checks);

        if (checks.stripe && checks.bookingFn && checks.validation && checks.config && checks.formExists) {
            try {
                // Initialize Stripe
                if ('{{ stripe_publishable_key }}' && Stripe) {
                    window.stripe = Stripe('{{ stripe_publishable_key }}');
                    console.log('Stripe initialized');
                }

                // Initialize AOS
                if (typeof AOS !== 'undefined') {
                    AOS.init({ duration: 800, once: true });
                    console.log('AOS initialized');
                }

                // Initialize booking system
                window.initializeBookingSystem();
                console.log('Booking system fully initialized');

                return true;
            } catch (error) {
                console.error('Initialization error:', error);
                return false;
            }
        } else if (initAttempts < maxAttempts) {
            setTimeout(initializeBookingSystemSafe, 200);
        } else {
            console.error('Max init attempts reached');
            // Emergency fallback - show first step
            const firstStep = document.querySelector('.form-step[data-step="1"]');
            if (firstStep) {
                firstStep.classList.add('active');
                firstStep.style.display = 'block';
            }
            console.log('Emergency fallback: Step 1 shown');
        }
    }

    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeBookingSystemSafe);
    } else {
        initializeBookingSystemSafe();
    }

    // Backup trigger
    window.addEventListener('load', initializeBookingSystemSafe);
})();
</script>
{% endblock %}